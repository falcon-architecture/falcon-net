name: CI Pipeline

on:
  push:
    branches:
      - "feature/*"
    paths-ignore: ["docfx", "samples", ".github"]
  pull_request:
    branches:
      - "master"
    paths-ignore: ["docfx", "samples", ".github"]
  release:
    types: [created, published, released, prereleased, deleted]
  workflow_dispatch:
    inputs:
      codeql:
        description: "Run CodeQL Analysis"
        default: true
        type: boolean
      sonarqube:
        description: "Run SonarQube Analysis"
        default: true
        type: boolean
      docfx:
        description: "Run DocFx Documentation"
        default: true
        type: boolean
      github-publish:
        description: "Run GitHub Publish"
        default: true
        type: boolean
      nuget-publish:
        description: "Run NuGet Publish"
        default: true
        type: boolean
      debug:
        description: "Debug Mode"
        default: false
        type: boolean

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dotnet-version: [9.0.x]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/checkout@v4
        with:
          repository: falcon-architecture/gh-actions
          ref: main
          path: gh-actions
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Dotnet Application Task
        uses: ./gh-actions/dotnet/build
        with:
          solution-path: ./Falcon.sln
          test-solution-path: ./tests/Falcon.Tests.sln
          dotnet-version: ${{ matrix.dotnet-version }}

  codeql:
    if: ${{ github.event.inputs.codeql == 'true' }}
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      matrix:
        dotnet-version: [9.0.x]
        languages: ["csharp"]
    env:
      ACTIONS_STEP_DEBUG: ${{ github.event.inputs.debug }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/checkout@v4
        with:
          repository: falcon-architecture/gh-actions
          ref: main
          path: gh-actions
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: CodeQL Analysis Task
        uses: ./gh-actions/dotnet/codeql
        with:
          dotnet-version: ${{ matrix.dotnet-version }}
          solution-path: ./Falcon.sln
          test-solution-path: ./tests/Falcon.Tests.sln
          languages: ${{ matrix.languages }}

  sonarqube:
    if: ${{ github.event.inputs.sonarqube == 'true' }}
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    strategy:
      matrix:
        languages: ["csharp"]
        dotnet-version: ["9.0.x"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/checkout@v4
        with:
          repository: falcon-architecture/gh-actions
          ref: main
          path: gh-actions
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: SonarQube Analysis Task
        uses: ./gh-actions/dotnet/sonarqube
        with:
          sources: src
          solution-path: ./Falcon.sln
          inclusions: "src/**"
          exclusions: "samples/**,resources/**,docfx/**"
          tests: tests
          test-solution-path: ./tests/Falcon.Tests.sln
          test-exclusions: "tests/**,samples/**,resources/**,docfx/**"
          dotnet-version: ${{ matrix.dotnet-version }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          sonar-project-key: "falcon-architecture_falcon-net"
          sonar-organization: "falcon-architecture"
          sonar-token: ${{ secrets.FALCON_SONAR_TOKEN }}
          verbose: ${{ github.event.inputs.debug }}

  docfx:
    if: ${{ github.event.inputs.docfx == 'true' }}
    name: DocFx Documentation
    runs-on: ubuntu-latest
    permissions:
      contents: write
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
    strategy:
      matrix:
        languages: ["csharp"]
        dotnet-version: ["9.0.x"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/checkout@v4
        with:
          repository: falcon-architecture/gh-actions
          ref: main
          path: gh-actions
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: DocFx Documentation Task
        uses: ./gh-actions/dotnet/docfx
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          solution-path: ./Falcon.sln
          dotnet-version: ${{ matrix.dotnet-version }}
          docfx-json-path: ./docfx/docfx.json
          publish-dir: docs

  github-publish:
    needs: build
    if: ${{ github.event_name == 'release' }}
    name: Publish Artifacts to GitHub
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dotnet-version: [9.0.x]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/checkout@v4
        with:
          repository: falcon-architecture/gh-actions
          ref: main
          path: gh-actions
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to GitHub Packages Task
        uses: ./gh-actions/dotnet/github/publish
        with:
          solution-path: ./Falcon.sln
          dotnet-version: ${{ matrix.dotnet-version }}
          # nuget-api-key: ${{ secrets.FALCON_NUGET_API_KEY }}
          github-user: natarajanganapathi
          github-email: natarajanmca11@outlook.com
          github-api-key: ${{ secrets.GITHUB_API_KEY }}
          version: ${{github.event.release.tag_name}}

  nuget-publish:
    needs: build
    if: ${{ github.event_name == 'release' }}
    name: Publish Artifacts to NuGet
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dotnet-version: [9.0.x]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/checkout@v4
        with:
          repository: falcon-architecture/gh-actions
          ref: main
          path: gh-actions
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to Nuget Packages Task
        uses: ./gh-actions/dotnet/nuget/publish
        with:
          solution-path: ./Falcon.sln
          dotnet-version: ${{ matrix.dotnet-version }}
          nuget-api-key: ${{ secrets.FALCON_NUGET_API_KEY }}
          version: ${{github.event.release.tag_name}}
